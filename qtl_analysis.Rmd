---
title: "qtl_analysis"
author: "SERGIO PEREZ-LIMON"
date: "3/7/2021"
output: 
  html_document: 
    keep_md: yes
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Load libraries, set seed and set working directory

```{r}
library(tidyverse)
library(googlesheets4)
library(googledrive)
library(qtl)
library(broom)

# Set the seed as the same value as previous analysis
set.seed(54955149)

# set working directory the same as project directory
setwd("D:/RS Lab/HUN_Ionomics")
```

Functions

```{r}

# transform p.value to significance codes
p.value_to_ast <- function(p.value) {
  
  ast <- case_when(
    p.value < 0.001 ~ "***",
    p.value >= 0.001 & p.value < 0.01 ~ "**",
    p.value >= 0.01 & p.value < 0.05 ~ "*",
    p.value >= 0.05 & p.value < 0.01 ~ ".",
    p.value > 0.01 ~ "NS",
    T ~ NA_character_)
  
  return(ast)
  
}

# raincloud plots function
raincloud_plot <- function(data, tissue) {
  
  plot <- data %>%
    ggplot(data =., 
           aes(x = hun, 
               y = value, 
               fill = hun)
           ) +
    ggdist::stat_halfeye(aes(fill = hun),
                         adjust = .5, 
                         width = .6, 
                         .width = 0, 
                         justification = -.2, 
                         point_colour = NA,
                         color = "black",
                         ) +
    geom_boxplot(
      width = .15, 
      outlier.shape = NA,
      color = "black"
      ) +
    gghalves::geom_half_point(
      ## draw jitter on the left
      side = "l", 
      ## control range of jitter
      range_scale = .4, 
      ## add some transparency
      alpha = .5,
      shape = 21,
      color = "black"
      ) +
    ggpubr::stat_compare_means(
      comparisons = list(c("HUN", "WT")),
      label = "p.signif",
      method = "wilcox.test") +
    xlab(NULL) +
    ylab("ppm") +
    theme(
      panel.background = element_rect(fill = "white", 
                                      colour ="grey50"),
      plot.title = element_text(hjust = 0.5)
      ) +
    scale_fill_manual(
      values = hun_color_scheme, guide = NULL
      ) +
    ggtitle(tissue)
  
  return(plot)
}

# transform summary and add information in a suitable tibble
summary.to.tibble <- function(CROSS, SCANONE, PERMS, ...) {
  
  a <- summary(
    object = SCANONE, 
    perms = PERMS,
    format = "tabByChr",
    ci.function = "lodint",
    ...
  ) 
  
  
  b <- summary(PERMS, ...)
  
  c <- tibble(
    phenotype = b %>% attr("dimnames") %>% .[[2]],
    threshold = b %>% as.numeric() %>% round(., 3)
  )
  
  p1 <- a %>%
    map_df(
      .x = ., 
      .f = ~ as_tibble(.x, rownames = "qtl"), 
      .id = "chr"
    ) %>%
    separate(
      qtl, 
      into = c("phenotype", "marker"), 
      sep = " : "
    ) %>%
    arrange(chr, pos, phenotype) %>%
    mutate(
      marker = map2_chr(
        .x = chr,
        .y = pos,
        .f = ~ find.marker(cross = CROSS,
                           chr = .x,
                           pos = .y)))
  
  p2 <- p1 %>%
    pivot_longer(c(pos, ci.low, ci.high)) %>%
    mutate(
      c_marker = map2_chr(
        .x = chr,
        .y = value,
        .f = ~ find.marker(
          cross = CROSS,       
          chr = .x,
          pos = .y
        )
      )) %>%
    mutate(c_marker = gsub("^\\d{1,}_", "", c_marker) %>% as.integer,
           c_marker = round(c_marker/1e6, 3),
           name = paste0("p_", name)) %>%
    select(-value) %>%
    pivot_wider(names_from = name, values_from = c_marker) %>%
    mutate(interval = p_ci.high - p_ci.low)
  
  p3 <- p1 %>%
    left_join(p2, by = c("phenotype", "marker", "chr", "lod")) %>%
    left_join(c, by = "phenotype")
  
  
  return(p3)
}

# transform results in df to use to plot in ggplot2
lodplot_map_df <- function(SCANONE, PERMS, SUMMARY, ...) {
  
  a <- SCANONE %>%
    as_tibble(rownames = "marker")
  
  dist_cM <- a %>%
    select(chr, pos) %>%
    group_by(chr) %>%
    filter(pos == max(pos)) %>%
    ungroup %>%
    mutate(fin = lag(pos),
           space = (5),
           pen = ifelse(is.na(fin), 0, pos + fin + space),
           pen2 = cumsum(pen)) %>%
    select(chr, pen2)
  
  b <- summary(PERMS, ...)
  
  c <- tibble(
    phenotype = b %>% attr("dimnames") %>% .[[2]],
    threshold = b %>% as.numeric() %>% round(., 3)
  )
  
  d <- SUMMARY %>%
    select(phenotype, chr, ci.low, ci.high) %>%
    rename(phenotype = phenotype)
  
  e <- a %>%
    left_join(dist_cM, by = "chr") %>%
    mutate(cM = pos + pen2) %>%
    select(-pen2) %>%
    select(marker:pos, cM, names(.)) %>%
    pivot_longer(
      cols = -c(marker:cM), 
      names_to = "phenotype", 
      values_to = "lod"
    ) %>%
    left_join(c, by = c("phenotype")) %>%
    left_join(d, by = c("chr", "phenotype")) %>%
    mutate(y = pmap_dbl(
      .l = .,
      .f = ~ with( 
        list(...),
        ifelse(between(pos, ci.low, ci.high),
               lod,
               NA_real_
               ))))  %>%
    mutate(alpha = ifelse(is.na(y), 0, 1)) %>%
    mutate(chr = as.integer(chr))
  
  breaks <- e %>%
    group_by(chr) %>%
    summarise(breaks = mean(cM))
  
  f <- e %>%
    left_join(breaks, by = "chr")
  
  return(f)
}

```
Importing data

Data that is goint to be used:

1. Ionomics Data
2. CML312 x W22 HUN mapping population genetic map

```{r}
phenotypes_url <- "https://docs.google.com/spreadsheets/d/1zC8c44uLXKEccDdUKaMmhRGn0JU5wNt1iOYS1xmPWGs/edit#gid=1931442445"

gen_map_url <- "https://docs.google.com/spreadsheets/d/1Abx_s6XxjG91YlLIaFxNn4HNcbnA3lKRgR0jw2DZZek/edit#gid=1187220000"

# Importing lsmeans from the sheets document
ionomics_phenotypes_raw <- phenotypes_url %>%
  as_id %>%
  range_read(., na = "NA") %>%
  select(id = GEN, hun = HUN, matches("seed|leaf"))

#Importing the genetic map of the CML312xW22 HUN F2 mapping population

gen_map <- gen_map_url %>%
  as_id %>%
  range_read(., na = "NA", col_types = "c") 

gen_map <- gen_map %>%
  mutate(id = ifelse(is.na(id), "", id))
```

Transforming data:

- Selecting ionomic phenotypes for leaf and seed
- Declaring color scheme for HUN levels: hun (Non-Pikachu yellow) and wt (green).

```{r}
ionomics_phenotypes <- ionomics_phenotypes_raw %>%
  filter(id != "ARES") %>%
  pivot_longer(-c(id, hun)) %>%
  mutate(name = gsub("\\.SR", "", name)) %>%
  separate(name, into = c("ion", "tissue")) %>%
  filter(!is.na(value))

# Declaring color scheme for hun 
hun_color_scheme <- c("HUN" = "#EDB120", "WT" = "#77AC30")
```

Declaring input and output directories in drive

```{r}
output_tables_drive_id <- "https://drive.google.com/drive/folders/1xYdj_AHkOsQaOoY6SgKDTuHZBoiww9Ci" %>%
  as_id

output_plots_drive_id <- "https://drive.google.com/drive/folders/1L1gh2-bIE_0CGPVt7iy7MVL7YuIs0xDD" %>%
  as_id

input_data_drive_id <-  "https://drive.google.com/drive/u/0/folders/19bOcGgnv6YvjdoQtVXsehf6_2NpCkynS" %>%
  as_id
```

First Look at data.

1. Compare means of HUN and WT families using Kruskal-Wallis non parametric test for every ion and tissue.
2. Make raincloud-plots by ion and tissue, and compare between medians using Kruskal-Wallis non parametric test.

```{r}
# create directory for results
dir.create(file.path(getwd(), "output"))
dir.create(file.path(paste0(getwd(), "/output"), "tables"))

# Compare distributions with kruskal-wallis test
ion_tissue_kw <- ionomics_phenotypes %>%
  group_by(ion, tissue) %>%
  nest %>%
  mutate(kw = map(.x = data, 
                  .f = ~ kruskal.test(value ~ hun, 
                                      data = .x))) %>%
  mutate(kw_tidy = map(.x = kw, .f = ~ tidy(.x))) %>%
  ungroup %>%
  select(ion, tissue, kw_tidy) %>%
  unnest(kw_tidy) %>%
  select(ion:p.value) %>%
  mutate(sig = p.value_to_ast(p.value)) %>%
  arrange(ion, tissue)

# save kruskal-wallis test df
write_csv(ion_tissue_kw,
          "output/tables/ion_tissue_kruskal_wallis_test.csv")

# upload table to drive
drive_upload(
  media = "output/tables/ion_tissue_kruskal_wallis_test.csv",
  path = output_tables_drive_id,
  name = "ion_tissue_kruskal_wallis_test.csv",
  type = "spreadsheet"
  )

# Note: comparison of distributions using kruskal-wallis
ionomics_raincloud_plots <- ionomics_phenotypes %>%
  group_by(ion, tissue) %>%
  mutate(hun = factor(hun, levels = c("WT", "HUN"))) %>%
  nest  %>%
  mutate(plot = map2(.x = data, 
                     .y = tissue,
                     .f = ~ raincloud_plot(data = .x, 
                                           tissue = .y))) %>%
  select(ion, plot) %>%
  group_by(ion) %>%
  summarise(plot = list(plot)) %>% 
  mutate(title = paste0("Ion: ", ion)) %>%
  mutate(wrap = map2(
    .x = plot, 
    .y = title,
    .f = ~ patchwork::wrap_plots(.x, guides = "collect") +
      patchwork::plot_annotation( 
        title = .y,
        theme = theme(plot.title = element_text(hjust = 0.5)
                      )
        )
    )) %>%
  ungroup

p <- ionomics_raincloud_plots$wrap

# create directory for plots
dir.create(file.path(paste0(getwd(), "/output"), "plots"))
dir.create(file.path(paste0(getwd(), "/output/plots"), "rainclowd_plots"))

# Saving plots into a single pdf
pdf("output/plots/rainclowd_plots/ions_raincloud_plots.pdf",
    onefile = TRUE)
map(p, ~ print(.x))
dev.off()

#save raincloud plots to google drive
drive_upload(
  media = "output/plots/rainclowd_plots/ions_raincloud_plots.pdf",
  path = output_plots_drive_id,
  name = "ions_raincloud_plots.pdf",
  type = "pdf"
  )

```

Create CrossObject

1. Create new traits: proportion between leaf/seed values
2. Create CrossObject

```{r}
# ion phenotypes
phenotypes_ion <- ionomics_phenotypes %>%
  mutate(tissue = tolower(tissue)) %>%
  mutate(name = paste0(ion, "_", tissue)) %>%
  select(-c(ion, tissue)) %>%
    pivot_wider(names_from = name, values_from = value)

# ratio between leaf/seed
phenotypes_ratio <- ionomics_phenotypes %>%
  mutate(tissue = tolower(tissue)) %>%
  pivot_wider(names_fro = tissue, values_from = value) %>%
  mutate(ratio = leaf/seed) %>%
  select(-c(leaf:seed)) %>%
  mutate(ion = paste0(ion, "_ratio")) %>%
  pivot_wider(names_from = ion, values_from = ratio)

# join all phenotypes
phenotypes_all <- left_join(phenotypes_ion,
                            phenotypes_ratio) %>%
  select(id, hun, sort(names(.)))

# join all phenotypes with the genetic map and create the CrossObject
crossobject_ion_hun <- gen_map %>%
  mutate(enchar = nchar(id)) %>%
  mutate(id = ifelse(enchar != 6, 
                     gsub("HUN", "HUN0", id),
                     id)) %>%
  select(-enchar) %>%
  filter(id %in% c("", phenotypes_all$id)) %>%
  left_join(phenotypes_all) %>%
  select(all_of(names(phenotypes_all)), names(.)) %>%
  mutate(across(everything(), ~ as.character(.))) %>%
  mutate(across(all_of(names(phenotypes_all)),
                ~ ifelse(is.na(.) & row_number() < 3, "", .)))

# create directory for the CrossObject
dir.create(file.path(paste0(getwd(), "/output"), "crossobject"))

# save crossobject
write_csv(crossobject_ion_hun,
          "output/crossobject/crossobject_ion_hun.csv")

# upload crossobject to drive
drive_upload(
  media = "output/crossobject/crossobject_ion_hun.csv",
  path = input_data_drive_id,
  name = "crossobject_ion_hun.csv",
  type = "spreadsheet"
  )
```

QTL analysis

1. Import CrossObject
2. Create a pheno.col df
3. Identify covariate (genotype on marker 5_2269274)
4. Calculate genoprob and simprob
5. Scanone with an additive covariate model 

```{r}
# Import CrossObject
ion_crossobject <-  read.cross(
  format = "csv",
  dir = "output/crossobject",
  file = "crossobject_ion_hun.csv",
  genotypes = c("AA", "AB", "BB"),
  alleles = c("CML", "W22"),
  BC.gen = 0,
  F.gen = 2,
  estimate.map = F)

# creating a pheno.col dataframe
ion_pheno.col <- ion_crossobject %>%
  phenames %>%
  enframe(name = "pheno.col", value = "phenotype") %>%
  filter(row_number() > 2)
  
# Identifying covariate (hun genotype)
hun_cov <- pull.geno(ion_crossobject, chr = 5) %>% .[,"5_2269274"]
hun_cov[hun_cov == 3] <- 0

#NOTE: WT = 1; HUN = 0.

# Create directory to save the results

dir.create(file.path(paste0(getwd(), "/output"), 
                     "qtl_objects"))
dir.create(file.path(paste0(getwd(), "/output/qtl_objects"),
                     "scanone"))
dir.create(file.path(paste0(getwd(), "/output/qtl_objects"),
                     "permutations"))
dir.create(file.path(paste0(getwd(), "/output/tables"),
                     "scanone_summary"))

# calculate the genetic probabilities
ion_crossobject <- calc.genoprob(
  ion_crossobject, 
  step = 0.5
  )

# simulating genotypes
ion_crossobject <- sim.geno(
  ion_crossobject,
  n.draws = 128, 
  step = 0.5, 
  error.prob = 0.001
  )
```

QTL analysis with an additive covariate model

```{r}
######################################################
# Using scanone applying an additive covariate model #
######################################################

ion_crossobject_addcov.out.hk <- 
  scanone(ion_crossobject, 
          method = "hk",
          pheno.col = ion_pheno.col$pheno.col, 
          addcovar = hun_cov
          )

# save scanone
save(
  list = c("ion_crossobject_addcov.out.hk"), 
  file = "output/qtl_objects/scanone/ion_crossobject_addcov.out.hk.RData"
)

# Permutation test (1000 permutations)
ion_crossobject_addcov.operm <- 
  scanone(ion_crossobject, 
          method = "hk",
          pheno.col = ion_pheno.col$pheno.col, 
          addcovar = hun_cov,
          n.perm = 1000
          )
# save permutation test
save(
  list = c("ion_crossobject_addcov.operm"), 
  file = "output/qtl_objects/permutations/ion_crossobject_addcov.operm.RData"
)

# Summary, alpha = 0.05
summary(
  ion_crossobject_addcov.out.hk,
  perms = ion_crossobject_addcov.operm, alpha = c(0.1), 
  format= "tabByChr"
  ) 

# transform the summary to tibble
scanone_summary_add_cov <- summary.to.tibble(
  CROSS = ion_crossobject, 
  SCANONE = ion_crossobject_addcov.out.hk,
  PERMS = ion_crossobject_addcov.operm, 
  alpha = 0.1
  )

# Export the summary as a csv
write_csv(
  scanone_summary_add_cov,
  "output/tables/scanone_summary/scanone_summary_add_cov.csv"
)

# Create dataframe for lodplots
ion_add_cov_lodplot_df <- lodplot_map_df(
  SCANONE = ion_crossobject_addcov.out.hk,
  SUMMARY = scanone_summary_add_cov,
  PERMS = ion_crossobject_addcov.operm,
  alpha = 0.1,
  ci.funciton = "lodint"
  )

# lodplots for all the phenotypes
ion_add_cov_lodplots_all <- ion_add_cov_lodplot_df %>%
  group_by(phenotype) %>%
  nest %>%
  mutate(
    title = paste0(
      "QTL analysis for additive covariate for ",
      phenotype)) %>%
  mutate(
    plot = map2(
      .x = data, 
      .y = title,
      .f = ~ .x %>% 
        {
        ggplot(
          data =., 
          aes(x = cM, 
              y = lod, 
              group = interaction(chr, alpha)
          )
          ) +
            geom_line(size = 0.75, alpha = 0.3) +
          geom_line(
            aes(alpha = alpha),
            size = 0.75
            ) +
          geom_ribbon(
            aes(ymin = 0, ymax = y), 
            fill = "red", 
            alpha = 0.8
            ) +
          geom_hline( 
            aes(yintercept = unique(threshold)),
            color = "red",
            linetype = 2
            ) +
          scale_alpha_identity() +
          scale_x_continuous(
            name = "chr", 
            breaks = unique(.$breaks), 
            labels = unique(as.character((.$chr)))
            ) +
            theme(
              panel.background = 
                element_rect(
                fill = "white",
                colour = "grey50")) +
            ggtitle(.y)
      }
    )
  ) 

# create directory for plots
dir.create(file.path(paste0(getwd(), "/output/plots"),
                     "scanone_lodplots"))
p <- ion_add_cov_lodplots_all$plot

# Saving plots into a single pdf
ggsave(
   filename = 
     "output/plots/scanone_lodplots/ion_add_cov_lodplots_all.pdf", 
   plot = gridExtra::marrangeGrob(p, nrow=1, ncol=1), 
   width = 15, height = 9
)

# Only significant plots
ion_add_cov_lodplots_signif <- ion_add_cov_lodplots_all %>%
  semi_join(scanone_summary_add_cov)

p <- ion_add_cov_lodplots_signif$plot

# Saving plots into a single pdf
ggsave(
   filename = 
     "output/plots/scanone_lodplots/ion_add_cov_lodplots_signif.pdf", 
   plot = gridExtra::marrangeGrob(p, nrow=1, ncol=1), 
   width = 15, height = 9
)

# all significant plots in the same page

ion_add_cov_lodplots_signif_single <- ion_add_cov_lodplots_signif %>%
  select(phenotype, data) %>%
  unnest(data) %>% {
    ggplot(data =., 
           aes(x = cM, y = lod, group = interaction(chr, alpha))) +
      geom_line(size = 0.75, alpha = 0.3) +
      geom_line(aes(alpha = alpha), size = 0.75) +
      geom_ribbon(aes(ymin = 0, ymax = y), fill = "red", alpha = 0.8 ) +
      geom_hline(aes(yintercept = threshold), color = "red",
                 linetype = 2) +
      scale_alpha_identity() +
      scale_x_continuous(name = "chr", 
                         breaks = unique(.$breaks),
                         labels = unique(as.character((.$chr)))) +
  theme(panel.background = element_rect( fill = "white",
                                         colour = "grey50")) +
  ggtitle("QTL analysis sig peaks additive covariate") +
  facet_grid(phenotype ~ .)
      }

ggsave(
   filename =
     "output/plots/scanone_lodplots/ion_add_cov_lodplots_signif_single.pdf", 
   plot = ion_add_cov_lodplots_signif_single, 
   width = 15, 
   height = 18
)
```

QTL analysis with an interactive covariate model

```{r}
##################################################
# Using scanone aplying an interactive covariate #
##################################################

ion_crossobject_intcov.out.hk <- 
  scanone(ion_crossobject, 
          method = "hk",
          pheno.col = ion_pheno.col$pheno.col, 
          addcovar = hun_cov,
          intcovar = hun_cov
          )

# save scanone
save(
  list = c("ion_crossobject_intcov.out.hk"), 
  file = "output/qtl_objects/scanone/ion_crossobject_intcov.out.hk.RData"
)

# Permutation test
ion_crossobject_intcov.operm <- 
  scanone(ion_crossobject, 
          method = "hk",
          pheno.col = ion_pheno.col$pheno.col, 
          addcovar = hun_cov,
          intcovar = hun_cov,
          n.perm = 1000
          )

# save permutation test
save(
  list = c("ion_crossobject_intcov.operm"), 
  file = "output/qtl_objects/permutations/ion_crossobject_intcov.operm.RData"
)

# Summary 
summary(
  ion_crossobject_intcov.out.hk, 
  perms = ion_crossobject_intcov.operm, 
  alpha = c(0.05), 
  format= "tabByChr"
  )

# transform the summary to tibble
scanone_summary_int_cov <- summary.to.tibble(
  CROSS = ion_crossobject, 
  SCANONE = ion_crossobject_intcov.out.hk,
  PERMS = ion_crossobject_intcov.operm, 
  alpha = 0.1
  )

# Export the summary as a csv
write_csv(
  scanone_summary_int_cov,
  "output/tables/scanone_summary/scanone_summary_int_cov.csv"
)

# Create dataframe for lodplots
ion_int_cov_lodplot_df <- lodplot_map_df(
  SCANONE = ion_crossobject_intcov.out.hk,
  SUMMARY = scanone_summary_int_cov,
  PERMS = ion_crossobject_intcov.operm,
  alpha = 0.1,
  ci.funciton = "lodint"
  )

# lodplots for all the phenotypes
ion_int_cov_lodplots_all <- ion_int_cov_lodplot_df %>%
  group_by(phenotype) %>%
  nest %>%
  mutate(
    title = paste0(
      "QTL analysis for intitive covariate for ",
      phenotype)) %>%
  mutate(
    plot = map2(
      .x = data, 
      .y = title,
      .f = ~ .x %>% 
        {
        ggplot(
          data =., 
          aes(x = cM, 
              y = lod, 
              group = interaction(chr, alpha)
          )
          ) +
            geom_line(size = 0.75, alpha = 0.3) +
          geom_line(
            aes(alpha = alpha),
            size = 0.75
            ) +
          geom_ribbon(
            aes(ymin = 0, ymax = y), 
            fill = "red", 
            alpha = 0.8
            ) +
          geom_hline( 
            aes(yintercept = unique(threshold)),
            color = "red",
            linetype = 2
            ) +
          scale_alpha_identity() +
          scale_x_continuous(
            name = "chr", 
            breaks = unique(.$breaks), 
            labels = unique(as.character((.$chr)))
            ) +
            theme(
              panel.background = 
                element_rect(
                fill = "white",
                colour = "grey50")) +
            ggtitle(.y)
      }
    )
  ) 

# create directory for plots
dir.create(file.path(paste0(getwd(), "/output/plots"),
                     "scanone_lodplots"))
p <- ion_int_cov_lodplots_all$plot

# Saving plots into a single pdf
ggsave(
   filename = 
     "output/plots/scanone_lodplots/ion_int_cov_lodplots_all.pdf", 
   plot = gridExtra::marrangeGrob(p, nrow=1, ncol=1), 
   width = 15, height = 9
)

# Only significant plots
ion_int_cov_lodplots_signif <- ion_int_cov_lodplots_all %>%
  semi_join(scanone_summary_int_cov)

p <- ion_int_cov_lodplots_signif$plot

# Saving plots into a single pdf
ggsave(
   filename = 
     "output/plots/scanone_lodplots/ion_int_cov_lodplots_signif.pdf", 
   plot = gridExtra::marrangeGrob(p, nrow=1, ncol=1), 
   width = 15, height = 9
)


# all significant plots in the same page

ion_int_cov_lodplots_signif_single <- ion_int_cov_lodplots_signif %>%
  select(phenotype, data) %>%
  unnest(data) %>% {
    ggplot(data =., 
           aes(x = cM, y = lod, group = interaction(chr, alpha))) +
      geom_line(size = 0.75, alpha = 0.3) +
      geom_line(aes(alpha = alpha), size = 0.75) +
      geom_ribbon(aes(ymin = 0, ymax = y), fill = "red", alpha = 0.8 ) +
      geom_hline(aes(yintercept = threshold), color = "red",
                 linetype = 2) +
      scale_alpha_identity() +
      scale_x_continuous(name = "chr", 
                         breaks = unique(.$breaks),
                         labels = unique(as.character((.$chr)))) +
  theme(panel.background = element_rect( fill = "white",
                                         colour = "grey50")) +
  ggtitle("QTL analysis sig peaks intitive covariate") +
  facet_grid(phenotype ~ .)
      }

ggsave(
   filename =
     "output/plots/scanone_lodplots/ion_int_cov_lodplots_signif_single.pdf", 
   plot = ion_int_cov_lodplots_signif_single, 
   width = 15, 
   height = 18
)
```

Additive and Interactive models comparison

```{r}
# Comparing models and looking for evidence for interaction between QTLs and HUN covariate

# scanone
ion_int_add.out.hk <- c(
  ion_crossobject_intcov.out.hk,
  ion_crossobject_intcov.out.hk - ion_crossobject_addcov.out.hk,
  labels = c("f", "i")
)

# save scanone
save(
  list = c("ion_int_add.out.hk"), 
  file = "output/qtl_objects/scanone/ion_int_add.out.hk.RData"
)

# permutations
ion_int_add.operm <- cbind(
  ion_crossobject_intcov.operm,
  ion_crossobject_intcov.operm - ion_crossobject_addcov.operm,
  labels = c("f", "i")
)

# save permutation test
save(
  list = c("ion_int_add.operm"), 
  file = "output/qtl_objects/permutations/ion_int_add.operm.RData"
)

# Summary
summary(
  ion_int_add.out.hk, 
  perms = ion_int_add.operm, 
  alpha = c(0.05), 
  format = "tabByChr"
  )

# transform the summary to tibble
scanone_summary_int_add_cov <- summary.to.tibble(
  CROSS = ion_crossobject, 
  SCANONE = ion_int_add.out.hk,
  PERMS = ion_int_add.operm, 
  alpha = 0.1
  )

# Export the summary as a csv
write_csv(
  scanone_summary_int_add_cov,
  "output/tables/scanone_summary/scanone_summary_int_add_cov.csv"
)

ions_interesting_qtl_addint <- scanone_summary_int_add_cov %>%
  arrange(phenotype) %>%
  separate(phenotype, into = c("phenotype2", "model"), sep = "\\.",
           remove = F) %>%
  group_by(phenotype2, chr) %>%
  filter(n() != 1)

# Create dataframe for lodplots
ion_int_add_cov_lodplot_df <- lodplot_map_df(
  SCANONE = ion_int_add.out.hk,
  SUMMARY = scanone_summary_int_add_cov,
  PERMS = ion_int_add.operm,
  alpha = 0.1,
  ci.funciton = "lodint"
  )

# lodplots for all the phenotypes
ion_int_add_cov_lodplots_all <- ion_int_add_cov_lodplot_df %>%
  group_by(phenotype) %>%
  nest %>%
  arrange(phenotype) %>%
  mutate(
    title = paste0(
      "QTL analysis for int_additive covariate for ",
      phenotype)) %>%
  mutate(
    plot = map2(
      .x = data, 
      .y = title,
      .f = ~ .x %>% 
        {
        ggplot(
          data =., 
          aes(x = cM, 
              y = lod, 
              group = interaction(chr, alpha)
          )
          ) +
            geom_line(size = 0.75, alpha = 0.3) +
          geom_line(
            aes(alpha = alpha),
            size = 0.75
            ) +
          geom_ribbon(
            aes(ymin = 0, ymax = y), 
            fill = "red", 
            alpha = 0.8
            ) +
          geom_hline( 
            aes(yintercept = unique(threshold)),
            color = "red",
            linetype = 2
            ) +
          scale_alpha_identity() +
          scale_x_continuous(
            name = "chr", 
            breaks = unique(.$breaks), 
            labels = unique(as.character((.$chr)))
            ) +
            theme(
              panel.background = 
                element_rect(
                fill = "white",
                colour = "grey50")) +
            ggtitle(.y)
      }
    )
  ) 


p <- ion_int_add_cov_lodplots_all$plot

# Saving plots int_addo a single pdf
ggsave(
   filename = 
     "output/plots/scanone_lodplots/ion_int_add_cov_lodplots_all.pdf", 
   plot = gridExtra::marrangeGrob(p, nrow=1, ncol=1), 
   width = 15, height = 9
)

# Only significant plots
ion_int_add_cov_lodplots_signif <- ion_int_add_cov_lodplots_all %>%
  semi_join(scanone_summary_int_add_cov)

p <- ion_int_add_cov_lodplots_signif$plot

# Saving plots int_addo a single pdf
ggsave(
   filename = 
     "output/plots/scanone_lodplots/ion_int_add_cov_lodplots_signif.pdf", 
   plot = gridExtra::marrangeGrob(p, nrow=1, ncol=1), 
   width = 15, height = 9
)


# all significant plots in the same page

ion_int_add_cov_lodplots_interesting <- ion_int_add_cov_lodplots_all %>%
  semi_join(ions_interesting_qtl_addint) %>%
  select(phenotype, data) %>%
  unnest(data) %>% {
    ggplot(data =., 
           aes(x = cM, y = lod, group = interaction(chr, alpha))) +
      geom_line(size = 0.75, alpha = 0.3) +
      geom_line(aes(alpha = alpha), size = 0.75) +
      geom_ribbon(aes(ymin = 0, ymax = y), fill = "red", alpha = 0.8 ) +
      geom_hline(aes(yintercept = threshold), color = "red",
                 linetype = 2) +
      scale_alpha_identity() +
      scale_x_continuous(name = "chr", 
                         breaks = unique(.$breaks),
                         labels = unique(as.character((.$chr)))) +
  theme(panel.background = element_rect( fill = "white",
                                         colour = "grey50")) +
  ggtitle("QTL analysis sig peaks int_additive covariate") +
  facet_grid(phenotype ~ .)
      }

ggsave(
   filename =
     "output/plots/scanone_lodplots/ion_int_add_cov_lodplots_interesting.pdf", 
   plot = ion_int_add_cov_lodplots_interesting, 
   width = 15, 
   height = 18
)

```

Separate analysis on WT families

```{r}
################################
# Analysis on WT families ONLY #
################################

ion_crossobject_WT <- subset(ion_crossobject, ind  = hun_cov == 0)

# scanone for wt individuals
ion_crossobject_WT.out.hk <- 
  scanone(ion_crossobject_WT,
          method = "hk",
          pheno.col = ion_pheno.col$pheno.col
          )

# save scanone
save(
  list = c("ion_crossobject_WT.out.hk"), 
  file = "output/qtl_objects/scanone/ion_crossobject_WT.out.hk.RData"
)

# Permutation test (1000 permutations) subsetting for wt individuals
ion_crossobject_WT.operm <- 
  scanone(subset(ion_crossobject, ind  = hun_cov == 0),
          method = "hk",
          pheno.col = ion_pheno.col$pheno.col, 
          n.perm = 1000
          )
# save permutation test
save(
  list = c("ion_crossobject_WT.operm"), 
  file = "output/qtl_objects/permutations/ion_crossobject_WT.operm.RData"
)

# Summary, alpha = 0.05
summary(
  ion_crossobject_WT.out.hk,
  perms = ion_crossobject_WT.operm,
  alpha = c(0.1), 
  format= "tabByChr"
  ) 

# transform the summary to tibble
scanone_summary_WT <- summary.to.tibble(
  CROSS = ion_crossobject_WT, 
  SCANONE = ion_crossobject_WT.out.hk,
  PERMS = ion_crossobject_WT.operm, 
  alpha = 0.1
  )

# Export the summary as a csv
write_csv(
  scanone_summary_int_add_cov,
  "output/tables/scanone_summary/scanone_summary_WT.csv"
)

# Create dataframe for lodplots
ion_WT_lodplot_df <- lodplot_map_df(
  SCANONE = ion_crossobject_WT.out.hk,
  SUMMARY = scanone_summary_WT,
  PERMS = ion_crossobject_WT.operm,
  alpha = 0.1,
  )

# lodplots for all the phenotypes
ion_WT_lodplots_all <- ion_WT_lodplot_df %>%
  group_by(phenotype) %>%
  nest %>%
  arrange(phenotype) %>%
  mutate(
    title = paste0(
      "QTL analysis for int_additive covariate for ",
      phenotype)) %>%
  mutate(
    plot = map2(
      .x = data, 
      .y = title,
      .f = ~ .x %>% 
        {
        ggplot(
          data =., 
          aes(x = cM, 
              y = lod, 
              group = interaction(chr, alpha)
          )
          ) +
            geom_line(size = 0.75, alpha = 0.3) +
          geom_line(
            aes(alpha = alpha),
            size = 0.75
            ) +
          geom_ribbon(
            aes(ymin = 0, ymax = y), 
            fill = "red", 
            alpha = 0.8
            ) +
          geom_hline( 
            aes(yintercept = unique(threshold)),
            color = "red",
            linetype = 2
            ) +
          scale_alpha_identity() +
          scale_x_continuous(
            name = "chr", 
            breaks = unique(.$breaks), 
            labels = unique(as.character((.$chr)))
            ) +
            theme(
              panel.background = 
                element_rect(
                fill = "white",
                colour = "grey50")) +
            ggtitle(.y)
      }
    )
  ) 


p <- ion_WT_lodplots_all$plot

# Saving plots int_addo a single pdf
ggsave(
   filename = 
     "output/plots/scanone_lodplots/ion_WT_lodplots_all.pdf", 
   plot = gridExtra::marrangeGrob(p, nrow=1, ncol=1), 
   width = 15, height = 9
)

# Only significant plots
ion_WT_lodplots_signif <- ion_WT_lodplots_all %>%
  semi_join(scanone_summary_WT)

p <- ion_WT_lodplots_signif$plot

# Saving plots int_addo a single pdf
ggsave(
   filename = 
     "output/plots/scanone_lodplots/ion_WT_lodplots_signif.pdf", 
   plot = gridExtra::marrangeGrob(p, nrow=1, ncol=1), 
   width = 15, height = 9
)

# all significant plots in the same page

ion_WT_lodplots_signif <- ion_WT_lodplots_all %>%
  semi_join(ions_interesting_qtl_addint) %>%
  select(phenotype, data) %>%
  unnest(data) %>% {
    ggplot(data =., 
           aes(x = cM, y = lod, group = interaction(chr, alpha))) +
      geom_line(size = 0.75, alpha = 0.3) +
      geom_line(aes(alpha = alpha), size = 0.75) +
      geom_ribbon(aes(ymin = 0, ymax = y), fill = "red", alpha = 0.8 ) +
      geom_hline(aes(yintercept = threshold), color = "red",
                 linetype = 2) +
      scale_alpha_identity() +
      scale_x_continuous(name = "chr", 
                         breaks = unique(.$breaks),
                         labels = unique(as.character((.$chr)))) +
  theme(panel.background = element_rect( fill = "white",
                                         colour = "grey50")) +
  ggtitle("QTL analysis sig peaks int_additive covariate") +
  facet_grid(phenotype ~ .)
      }

ggsave(
   filename =
     "output/plots/scanone_lodplots/ion_WT_lodplots_signif.pdf", 
   plot = ion_WT_lodplots_interesting, 
   width = 15, 
   height = 18
)

```

Separate analysis on HUN families

```{r}

#################################
# Analysis on HUN families ONLY #
#################################
ion_crossobject_HUN <- subset(ion_crossobject, ind  = hun_cov == 1)

# scanone for HUN individuals
ion_crossobject_HUN.out.hk <- 
  scanone(ion_crossobject_HUN,
          method = "hk",
          pheno.col = ion_pheno.col$pheno.col
          )

# save scanone
save(
  list = c("ion_crossobject_HUN.out.hk"), 
  file = "output/qtl_objects/scanone/ion_crossobject_HUN.out.hk.RData"
)

# Permutation test (1000 permutations) subsetting for HUN individuals
ion_crossobject_HUN.operm <- 
  scanone(subset(ion_crossobject, ind  = hun_cov == 1),
          method = "hk",
          pheno.col = ion_pheno.col$pheno.col, 
          n.perm = 1000
          )
# save permutation test
save(
  list = c("ion_crossobject_HUN.operm"), 
  file = "output/qtl_objects/permutations/ion_crossobject_HUN.operm.RData"
)

# Summary, alpha = 0.05
summary(
  ion_crossobject_HUN.out.hk,
  perms = ion_crossobject_HUN.operm,
  alpha = c(0.1), 
  format= "tabByChr"
  ) 

# transform the summary to tibble
scanone_summary_HUN <- summary.to.tibble(
  CROSS = ion_crossobject_HUN, 
  SCANONE = ion_crossobject_HUN.out.hk,
  PERMS = ion_crossobject_HUN.operm, 
  alpha = 0.1
  )

# Export the summary as a csv
write_csv(
  scanone_summary_int_add_cov,
  "output/tables/scanone_summary/scanone_summary_HUN.csv"
)

# Create dataframe for lodplots
ion_HUN_lodplot_df <- lodplot_map_df(
  SCANONE = ion_crossobject_HUN.out.hk,
  SUMMARY = scanone_summary_HUN,
  PERMS = ion_crossobject_HUN.operm,
  alpha = 0.1,
  )

# lodplots for all the phenotypes
ion_HUN_lodplots_all <- ion_HUN_lodplot_df %>%
  group_by(phenotype) %>%
  nest %>%
  arrange(phenotype) %>%
  mutate(
    title = paste0(
      "QTL analysis for int_additive covariate for ",
      phenotype)) %>%
  mutate(
    plot = map2(
      .x = data, 
      .y = title,
      .f = ~ .x %>% 
        {
        ggplot(
          data =., 
          aes(x = cM, 
              y = lod, 
              group = interaction(chr, alpha)
          )
          ) +
            geom_line(size = 0.75, alpha = 0.3) +
          geom_line(
            aes(alpha = alpha),
            size = 0.75
            ) +
          geom_ribbon(
            aes(ymin = 0, ymax = y), 
            fill = "red", 
            alpha = 0.8
            ) +
          geom_hline( 
            aes(yintercept = unique(threshold)),
            color = "red",
            linetype = 2
            ) +
          scale_alpha_identity() +
          scale_x_continuous(
            name = "chr", 
            breaks = unique(.$breaks), 
            labels = unique(as.character((.$chr)))
            ) +
            theme(
              panel.background = 
                element_rect(
                fill = "white",
                colour = "grey50")) +
            ggtitle(.y)
      }
    )
  ) 


p <- ion_HUN_lodplots_all$plot

# Saving plots int_addo a single pdf
ggsave(
   filename = 
     "output/plots/scanone_lodplots/ion_HUN_lodplots_all.pdf", 
   plot = gridExtra::marrangeGrob(p, nrow=1, ncol=1), 
   width = 15, height = 9
)

# Only significant plots
ion_HUN_lodplots_signif <- ion_HUN_lodplots_all %>%
  semi_join(scanone_summary_HUN)

p <- ion_HUN_lodplots_signif$plot

# Saving plots int_addo a single pdf
ggsave(
   filename = 
     "output/plots/scanone_lodplots/ion_HUN_lodplots_signif.pdf", 
   plot = gridExtra::marrangeGrob(p, nrow=1, ncol=1), 
   width = 15, height = 9
)

# all significant plots in the same page

ion_HUN_lodplots_signif <- ion_HUN_lodplots_all %>%
  semi_join(ion_HUN_lodplots_signif) %>%
  select(phenotype, data) %>%
  unnest(data) %>% {
    ggplot(data =., 
           aes(x = cM, y = lod, group = interaction(chr, alpha))) +
      geom_line(size = 0.75, alpha = 0.3) +
      geom_line(aes(alpha = alpha), size = 0.75) +
      geom_ribbon(aes(ymin = 0, ymax = y), fill = "red", alpha = 0.8 ) +
      geom_hline(aes(yintercept = threshold), color = "red",
                 linetype = 2) +
      scale_alpha_identity() +
      scale_x_continuous(name = "chr", 
                         breaks = unique(.$breaks),
                         labels = unique(as.character((.$chr)))) +
  theme(panel.background = element_rect( fill = "white",
                                         colour = "grey50")) +
  ggtitle("QTL analysis sig peaks int_additive covariate") +
  facet_grid(phenotype ~ .)
      }

ggsave(
   filename =
     "output/plots/scanone_lodplots/ion_HUN_lodplots_signif.pdf", 
   plot = ion_HUN_lodplots_signif, 
   width = 15, 
   height = 18
)

```

QTLs detected in all the separated analysis

```{r}

# combine all scanone summaries
qtl_detected_all <- bind_rows(
  scanone_summary_add_cov %>% mutate(model = "add"),
  scanone_summary_int_cov %>% mutate(model = "int"),
  ions_interesting_qtl_addint %>% mutate(model = "addint"),
  scanone_summary_WT %>% mutate(model = "WT"),
  scanone_summary_HUN %>% mutate(model = "HUN")
  ) %>%
  select(-phenotype2)

# Combine all information for plots
qtl_detected_all_lodplot <- bind_rows(
  ion_add_cov_lodplots_all %>% mutate(model = "add"),
  ion_int_cov_lodplots_all %>% mutate(model = "int"),
  ion_int_add_cov_lodplots_all %>% mutate(model = "addint"),
  ion_WT_lodplots_all %>% mutate(model = "WT"),
  ion_HUN_lodplots_all %>% mutate(model = "HUN")
  ) %>%
  select(phenotype, data, model) %>%
  semi_join(qtl_detected_all) %>%
  arrange(phenotype)

# stablish a color scheme for the models in the plots

model_color_scheme <- 
  c(
    "add" = "#E41A1C", "addint.f" = "#377EB8", "addint.i" = "#4DAF4A",
    "HUN" = "#984EA3", "int" = "#FF7F00", "WT" = "#FFFF33"
    )

ion_lodplots_all_df <- qtl_detected_all_lodplot %>%
  mutate(prefix = str_extract(phenotype, "\\.(f|i)$")) %>%
  mutate(model = 
           ifelse(!is.na(prefix), 
                  paste0(model, prefix), 
                  model) 
         ) %>%
  select(-prefix) %>%
  mutate(phenotype = gsub("\\.(f|i)$", "", phenotype)) %>%
  filter(model != "addint.f") %>%
  separate(phenotype, into = c("ion", "tissue"), sep = "_") %>%
  mutate(tissue = factor(tissue,
                         levels = c("leaf", "seed", "ratio"))) %>%
  unnest(data) %>%
  group_by(ion) %>%
  nest %>%
  ungroup 

function_plots_a <- function(data, ion) {
  
  plot <- data %>%
    {
      ggplot(
        data =.,
        aes( x = cM, 
             y = lod, 
             group = interaction(chr, model),
             color = model)) +
        geom_line(size = 1,
                  alpha =  0.3) +
        geom_line(aes(alpha = alpha),
                  size = 1) +
        scale_alpha_identity() +
        scale_color_manual(values = model_color_scheme) +
        scale_x_continuous(name = NULL, 
                           breaks = unique(.$breaks), 
                           labels = unique(as.character((.$chr)))) +
        theme(panel.background = element_rect( fill = "white",
                                               colour = "grey50"),
              legend.position = "top",
              plot.title = element_text(hjust = 0.5)) +
        ylab("LOD") +
        facet_grid(tissue ~ .) +
        ggtitle(paste0("Ion: ", ion))
    }
  return(plot)
}


ion_lodplots_all_plot <- ion_lodplots_all_df %>% 
  mutate(plot = map2(.x = data, 
                     .y = ion, 
                     .f = ~ function_plots_a(data = .x, ion = .y)))

p <- ion_lodplots_all_plot$plot

# Saving plots int_addo a single pdf
ggsave(
   filename = 
     "output/plots/scanone_lodplots/ion_lodplots_all_plot.pdf", 
   plot = gridExtra::marrangeGrob(p, nrow=1, ncol=1), 
   width = 15, height = 9
)


```

Effect plots for QTLs identified in scanone

```{r}

qtl_detected_all %>%
  arrange(phenotype, chr)

```

