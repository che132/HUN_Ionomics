---
title: "qtl_analysis"
author: "SERGIO PEREZ-LIMON"
date: "3/7/2021"
output: 
  html_document: 
    keep_md: yes
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Load libraries, set seed and set working directory

```{r}
library(tidyverse)
library(googlesheets4)
library(googledrive)
library(qtl)
library(broom)

# Set the seed as the same value as previous analysis
set.seed(54955149)

# set working directory the same as project directory
setwd("D:/RS Lab/HUN_Ionomics")
```
Importing data

Data that is goint to be used:

1. Ionomics Data
2. CML312 x W22 HUN mapping population genetic map

```{r}
phenotypes_url <- "https://docs.google.com/spreadsheets/d/1zC8c44uLXKEccDdUKaMmhRGn0JU5wNt1iOYS1xmPWGs/edit#gid=1931442445"

gen_map_url <- "https://docs.google.com/spreadsheets/d/1Abx_s6XxjG91YlLIaFxNn4HNcbnA3lKRgR0jw2DZZek/edit#gid=1187220000"

# Importing lsmeans from the sheets document
ionomics_phenotypes_raw <- phenotypes_url %>%
  as_id %>%
  range_read(., na = "NA") %>%
  select(id = GEN, hun = HUN, matches("seed|leaf"))

#Importing the genetic map of the CML312xW22 HUN F2 mapping population

gen_map <- gen_map_url %>%
  as_id %>%
  range_read(., na = "NA", col_types = "c") 

gen_map <- gen_map %>%
  mutate(id = ifelse(is.na(id), "", id))
```

Transforming data:

- Selecting ionomic phenotypes for leaf and seed
- Declaring color scheme for HUN levels: hun (Non-Pikachu yellow) and wt (green).

```{r}
ionomics_phenotypes <- ionomics_phenotypes_raw %>%
  filter(id != "ARES") %>%
  pivot_longer(-c(id, hun)) %>%
  mutate(name = gsub("\\.SR", "", name)) %>%
  separate(name, into = c("ion", "tissue")) %>%
  filter(!is.na(value))

# Declaring color scheme for hun 
hun_color_scheme <- c("HUN" = "#EDB120", "WT" = "#77AC30")
```

Declaring input and output directories in drive

```{r}
output_tables_drive_id <- "https://drive.google.com/drive/folders/1xYdj_AHkOsQaOoY6SgKDTuHZBoiww9Ci" %>%
  as_id

output_plots_drive_id <- "https://drive.google.com/drive/folders/1L1gh2-bIE_0CGPVt7iy7MVL7YuIs0xDD" %>%
  as_id

input_data_drive_id <-  "https://drive.google.com/drive/u/0/folders/19bOcGgnv6YvjdoQtVXsehf6_2NpCkynS" %>%
  as_id
```

First Look at data.

1. Compare means of HUN and WT families using Kruskal-Wallis non parametric test for every ion and tissue.
2. Make raincloud-plots by ion and tissue, and compare between medians using Kruskal-Wallis non parametric test.

```{r}
# transform p.value to significance codes
p.value_to_ast <- function(p.value) {
  
  ast <- case_when(
    p.value < 0.001 ~ "***",
    p.value >= 0.001 & p.value < 0.01 ~ "**",
    p.value >= 0.01 & p.value < 0.05 ~ "*",
    p.value >= 0.05 & p.value < 0.01 ~ ".",
    p.value > 0.01 ~ "NS",
    T ~ NA_character_)
  
  return(ast)
  
}

# create directory for results
dir.create(file.path(getwd(), "output"))
dir.create(file.path(paste0(getwd(), "/output"), "tables"))

# Compare distributions with kruskal-wallis test
ion_tissue_kw <- ionomics_phenotypes %>%
  group_by(ion, tissue) %>%
  nest %>%
  mutate(kw = map(.x = data, 
                  .f = ~ kruskal.test(value ~ hun, 
                                      data = .x))) %>%
  mutate(kw_tidy = map(.x = kw, .f = ~ tidy(.x))) %>%
  ungroup %>%
  select(ion, tissue, kw_tidy) %>%
  unnest(kw_tidy) %>%
  select(ion:p.value) %>%
  mutate(sig = p.value_to_ast(p.value)) %>%
  arrange(ion, tissue)

# save kruskal-wallis test df
write_csv(ion_tissue_kw,
          "output/tables/ion_tissue_kruskal_wallis_test.csv")

# upload table to drive
drive_upload(
  media = "output/tables/ion_tissue_kruskal_wallis_test.csv",
  path = output_tables_drive_id,
  name = "ion_tissue_kruskal_wallis_test.csv",
  type = "spreadsheet"
  )

# raincloud plots function
raincloud_plot <- function(data, tissue) {
  
  plot <- data %>%
    ggplot(data =., 
           aes(x = hun, 
               y = value, 
               fill = hun)
           ) +
    ggdist::stat_halfeye(aes(fill = hun),
                         adjust = .5, 
                         width = .6, 
                         .width = 0, 
                         justification = -.2, 
                         point_colour = NA,
                         color = "black",
                         ) +
    geom_boxplot(
      width = .15, 
      outlier.shape = NA,
      color = "black"
      ) +
    gghalves::geom_half_point(
      ## draw jitter on the left
      side = "l", 
      ## control range of jitter
      range_scale = .4, 
      ## add some transparency
      alpha = .5,
      shape = 21,
      color = "black"
      ) +
    ggpubr::stat_compare_means(
      comparisons = list(c("HUN", "WT")),
      label = "p.signif",
      method = "wilcox.test") +
    xlab(NULL) +
    ylab("ppm") +
    theme(
      panel.background = element_rect(fill = "white", 
                                      colour ="grey50"),
      plot.title = element_text(hjust = 0.5)
      ) +
    scale_fill_manual(
      values = hun_color_scheme, guide = NULL
      ) +
    ggtitle(tissue)
  
  return(plot)
}

# Note: comparison of distributions using kruskal-wallis
ionomics_raincloud_plots <- ionomics_phenotypes %>%
  group_by(ion, tissue) %>%
  mutate(hun = factor(hun, levels = c("WT", "HUN"))) %>%
  nest  %>%
  mutate(plot = map2(.x = data, 
                     .y = tissue,
                     .f = ~ raincloud_plot(data = .x, 
                                           tissue = .y))) %>%
  select(ion, plot) %>%
  group_by(ion) %>%
  summarise(plot = list(plot)) %>% 
  mutate(title = paste0("Ion: ", ion)) %>%
  mutate(wrap = map2(
    .x = plot, 
    .y = title,
    .f = ~ patchwork::wrap_plots(.x, guides = "collect") +
      patchwork::plot_annotation( 
        title = .y,
        theme = theme(plot.title = element_text(hjust = 0.5)
                      )
        )
    )) %>%
  ungroup

p <- ionomics_raincloud_plots$wrap

# create directory for plots
dir.create(file.path(paste0(getwd(), "/output"), "plots"))
dir.create(file.path(paste0(getwd(), "/output/plots"), "rainclowd_plots"))

# Saving plots into a single pdf
pdf("output/plots/rainclowd_plots/ions_raincloud_plots.pdf",
    onefile = TRUE)
map(p, ~ print(.x))
dev.off()

#save raincloud plots to google drive
drive_upload(
  media = "output/plots/rainclowd_plots/ions_raincloud_plots.pdf",
  path = output_plots_drive_id,
  name = "ions_raincloud_plots.pdf",
  type = "pdf"
  )

```

Create CrossObject

1. Create new traits: proportion between leaf/seed values
2. Create CrossObject

```{r}
# ion phenotypes
phenotypes_ion <- ionomics_phenotypes %>%
  mutate(tissue = tolower(tissue)) %>%
  mutate(name = paste0(ion, "_", tissue)) %>%
  select(-c(ion, tissue)) %>%
    pivot_wider(names_from = name, values_from = value)

# ratio between leaf/seed
phenotypes_ratio <- ionomics_phenotypes %>%
  mutate(tissue = tolower(tissue)) %>%
  pivot_wider(names_fro = tissue, values_from = value) %>%
  mutate(ratio = leaf/seed) %>%
  select(-c(leaf:seed)) %>%
  mutate(ion = paste0(ion, "_ratio")) %>%
  pivot_wider(names_from = ion, values_from = ratio)

# join all phenotypes
phenotypes_all <- left_join(phenotypes_ion,
                            phenotypes_ratio) %>%
  select(id, hun, sort(names(.)))

# join all phenotypes with the genetic map and create the CrossObject
crossobject_ion_hun <- gen_map %>%
  mutate(enchar = nchar(id)) %>%
  mutate(id = ifelse(enchar != 6, 
                     gsub("HUN", "HUN0", id),
                     id)) %>%
  select(-enchar) %>%
  filter(id %in% c("", phenotypes_all$id)) %>%
  left_join(phenotypes_all) %>%
  select(all_of(names(phenotypes_all)), names(.)) %>%
  mutate(across(everything(), ~ as.character(.))) %>%
  mutate(across(all_of(names(phenotypes_all)),
                ~ ifelse(is.na(.) & row_number() < 3, "", .)))

# create directory for the CrossObject
dir.create(file.path(paste0(getwd(), "/output"), "crossobject"))

# save crossobject
write_csv(crossobject_ion_hun,
          "output/crossobject/crossobject_ion_hun.csv")

# upload crossobject to drive
drive_upload(
  media = "output/crossobject/crossobject_ion_hun.csv",
  path = input_data_drive_id,
  name = "crossobject_ion_hun.csv",
  type = "spreadsheet"
  )
```

QTL analysis

1. Import CrossObject
2. Create a pheno.col df
3. Identify covariate (genotype on marker 5_2269274)
4. Calculate genoprob and simprob
5. Scanone with an additive covariate model 

```{r}

# Import CrossObject
ion_crossobject <-  read.cross(
  format = "csv",
  dir = "output/crossobject",
  file = "crossobject_ion_hun.csv",
  genotypes = c("AA", "AB", "BB"),
  alleles = c("CML", "W22"),
  BC.gen = 0,
  F.gen = 2,
  estimate.map = F)

# creating a pheno.col dataframe
ion_pheno.col <- ion_crossobject %>%
  phenames %>%
  enframe(name = "pheno.col", value = "phenotype") %>%
  filter(row_number() > 2)
  
# Identifying covariate (hun genotype)
hun_cov <- pull.geno(ion_crossobject, chr = 5) %>% .[,"5_2269274"]
hun_cov[hun_cov == 3] <- 0

# Create directory to save the results

dir.create(file.path(paste0(getwd(), "/output"), 
                     "qtl_objects"))
dir.create(file.path(paste0(getwd(), "/output/qtl_objects"),
                     "scanone"))
dir.create(file.path(paste0(getwd(), "/output/qtl_objects"),
                     "permutations"))

# calculate the genetic probabilities
ion_crossobject <- calc.genoprob(
  ion_crossobject, 
  step = 0.5
  )

# simulating genotypes
ion_crossobject <- sim.geno(
  ion_crossobject,
  n.draws = 128, 
  step = 0.5, 
  error.prob = 0.001
  )

# Using scanone applying an additive covariate model

ion_crossobject_addcov.out.hk <- 
  scanone(ion_crossobject, 
          method = "hk",
          pheno.col = ion_pheno.col$pheno.col, 
          addcovar = hun_cov
          )

# save scanone
save(
  list = c("ion_crossobject_addcov.out.hk"), 
  file = "output/qtl_objects/scanone/ion_crossobject_addcov.out.hk.RData"
)

# Permutation test (1000 permutations)
ion_crossobject_addcov.operm <- 
  scanone(ion_crossobject, 
          method = "hk",
          pheno.col = ion_pheno.col$pheno.col, 
          addcovar = hun_cov,
          n.perm = 1000
          )
# save permutation test
save(
  list = c("ion_crossobject_addcov.operm"), 
  file = "output/qtl_objects/permutations/ion_crossobject_addcov.operm.RData"
)

# Summary, alpha = 0.05
summary(ion_crossobject_addcov.out.hk, 
        perms = ion_crossobject_addcov.operm, alpha = c(0.1), 
        format= "tabByChr")


# Using scanone aplying an interactive covariate

ion_crossobject_intcov.out.hk <- 
  scanone(ion_crossobject, 
          method = "hk",
          pheno.col = ion_pheno.col$pheno.col, 
          addcovar = hun_cov,
          intcovar = hun_cov
          )

# save scanone
save(
  list = c("ion_crossobject_intcov.out.hk"), 
  file = "output/qtl_objects/scanone/ion_crossobject_intcov.out.hk.RData"
)

# Permutation test
ion_crossobject_intcov.operm <- 
  scanone(ion_crossobject, 
          method = "hk",
          pheno.col = ion_pheno.col$pheno.col, 
          addcovar = hun_cov,
          intcovar = hun_cov,
          n.perm = 1000
          )

# save permutation test
save(
  list = c("ion_crossobject_intcov.operm"), 
  file = "output/qtl_objects/permutations/ion_crossobject_intcov.operm.RData"
)

# Summary 
summary(
  ion_crossobject_intcov.out.hk, 
  perms = ion_crossobject_intcov.operm, 
  alpha = c(0.05), 
  format= "tabByChr"
  )

# Comparing models and looking for evidence for interaction between QTLs and HUN covariate

# scanone
ion_int_add.out.hk <- c(
  ion_crossobject_intcov.out.hk,
  ion_crossobject_intcov.out.hk - ion_crossobject_addcov.out.hk,
  labels = c("f", "i")
)

# save scanone
save(
  list = c("ion_int_add.out.hk"), 
  file = "output/qtl_objects/scanone/ion_int_add.out.hk.RData"
)

# permutations
ion_int_add.operm <- cbind(
  ion_crossobject_intcov.operm,
  ion_crossobject_intcov.operm - ion_crossobject_addcov.operm,
  labels = c("f", "i")
)

# save permutation test
save(
  list = c("ion_int_add.operm"), 
  file = "output/qtl_objects/permutations/ion_int_add.operm.RData"
)

# Summary
summary(
  ion_int_add.out.hk, 
  perms = ion_int_add.operm, 
  alpha = c(0.05), 
  format = "tabByChr"
  )





```

